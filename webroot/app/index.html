<!doctype html>
<html lang="zh">
<head>
  <meta charset="utf-8"/>
  <title>财务系统测试页</title>
  <style>
    body { font-family: "Microsoft YaHei", Arial; padding: 16px; }
    input { padding: 6px; margin-right: 10px; margin-bottom: 8px; }
    button { padding: 6px 12px; margin-right: 8px; margin-bottom: 8px; }
    pre { background:#f6f6f6; padding:12px; border-radius:8px; overflow:auto; }
    .box { border: 1px solid #ddd; border-radius: 8px; padding: 12px; margin-bottom: 12px; }
  </style>
</head>
<body>
  <h2>财务系统（登录 + 权限 + 财务录入）</h2>

  <div class="box">
    <h3>1) 登录 / 当前用户</h3>
    用户名：<input id="username" value="finance_a">
    密码：<input id="password" value="finance123" type="password">
    <button onclick="login()">登录</button>
    <button onclick="loadMe()">读取当前用户</button>
    <div>Token: <code id="tokenText">(未登录)</code></div>
  </div>

  <div class="box">
    <h3>2) 报表与台账</h3>
    公司ID：<input id="companyId" value="1">
    起始日期：<input id="dateFrom" value="2026-01-01">
    结束日期：<input id="dateTo" value="2026-01-31">
    <div>
      <button onclick="loadCostBenefit()">图1：成本效益分析</button>
      <button onclick="loadCostBenefitLedger()">台账：成本效益明细</button>
      <button onclick="loadApSummary()">图2：应付汇总</button>
      <button onclick="loadApAccrual()">应付计提明细</button>
      <button onclick="loadApPayment()">应付付款明细</button>
    </div>
  </div>

  <div class="box">
    <h3>3) 管理员接口</h3>
    新用户ID：<input id="newUserId" value="10">
    新用户名：<input id="newUsername" value="finance_new">
    新密码：<input id="newPassword" value="finance123">
    <div>
      <button onclick="loadUsers()">读取用户清单（管理员）</button>
      <button onclick="createUser()">创建财务用户（管理员）</button>
      <button onclick="loadPermissions()">读取权限清单（管理员）</button>
    </div>
  </div>

  <h3>接口返回（JSON）</h3>
  <pre id="out">点击按钮开始测试</pre>

<script>
let token = "";

async function fetchJson(url, options = {}) {
  const headers = Object.assign({}, options.headers || {});
  if (token) headers["Authorization"] = `Bearer ${token}`;

  const r = await fetch(url, Object.assign({}, options, { headers }));
  return await r.json();
}

function getParams() {
  return {
    companyId: document.getElementById('companyId').value.trim(),
    dateFrom: document.getElementById('dateFrom').value.trim(),
    dateTo: document.getElementById('dateTo').value.trim()
  };
}

function show(data) {
  document.getElementById('out').textContent = JSON.stringify(data, null, 2);
}

async function login() {
  const username = document.getElementById('username').value.trim();
  const password = document.getElementById('password').value.trim();

  const data = await fetchJson('/api/auth/login', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ username, password })
  });

  if (data.ok && data.data && data.data.token) {
    token = data.data.token;
    document.getElementById('tokenText').textContent = token;
  }

  show(data);
}

async function loadMe() {
  show(await fetchJson('/api/me'));
}

async function loadCostBenefit() {
  const p = getParams();
  const url = `/api/reports/cost_benefit?company_id=${encodeURIComponent(p.companyId)}&date_from=${encodeURIComponent(p.dateFrom)}&date_to=${encodeURIComponent(p.dateTo)}`;
  show(await fetchJson(url));
}

async function loadCostBenefitLedger() {
  const p = getParams();
  const url = `/api/finance/cost_benefit?company_id=${encodeURIComponent(p.companyId)}&date_from=${encodeURIComponent(p.dateFrom)}&date_to=${encodeURIComponent(p.dateTo)}`;
  show(await fetchJson(url));
}

async function loadApSummary() {
  const p = getParams();
  const url = `/api/reports/ap_summary?company_id=${encodeURIComponent(p.companyId)}&date_from=${encodeURIComponent(p.dateFrom)}&date_to=${encodeURIComponent(p.dateTo)}`;
  show(await fetchJson(url));
}

async function loadApAccrual() {
  const p = getParams();
  const url = `/api/finance/ap_accrual?company_id=${encodeURIComponent(p.companyId)}&date_from=${encodeURIComponent(p.dateFrom)}&date_to=${encodeURIComponent(p.dateTo)}`;
  show(await fetchJson(url));
}

async function loadApPayment() {
  const p = getParams();
  const url = `/api/finance/ap_payment?company_id=${encodeURIComponent(p.companyId)}&date_from=${encodeURIComponent(p.dateFrom)}&date_to=${encodeURIComponent(p.dateTo)}`;
  show(await fetchJson(url));
}

async function loadPermissions() {
  show(await fetchJson('/api/admin/permissions'));
}

async function loadUsers() {
  show(await fetchJson('/api/admin/users'));
}

async function createUser() {
  const body = {
    userId: Number(document.getElementById('newUserId').value.trim()),
    username: document.getElementById('newUsername').value.trim(),
    password: document.getElementById('newPassword').value.trim(),
    isAdmin: false
  };

  show(await fetchJson('/api/admin/users', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(body)
  }));
}
</script>
</body>
</html>
