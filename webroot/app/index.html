<!doctype html>
<html lang="zh">
<head>
  <meta charset="utf-8"/>
  <title>财务系统测试页</title>
  <style>
    body { font-family: "Microsoft YaHei", Arial; padding: 16px; background: #f5f6f8; }
    input { padding: 6px; margin-right: 10px; margin-bottom: 8px; }
    button { padding: 6px 12px; margin-right: 8px; margin-bottom: 8px; cursor: pointer; }
    pre { background:#f6f6f6; padding:12px; border-radius:8px; overflow:auto; }
    .box { border: 1px solid #ddd; border-radius: 8px; padding: 12px; margin-bottom: 12px; background:#fff; }
    .user-card { border:1px solid #d9d9d9; border-radius:10px; margin-bottom:12px; background:#fff; }
    .user-head { padding:10px 12px; display:flex; justify-content:space-between; align-items:center; }
    .user-table { width:100%; border-collapse:collapse; }
    .user-table th,.user-table td { border:1px solid #ececec; padding:8px; text-align:left; }
    .hidden { display:none; }
  </style>
</head>
<body>
  <h2>财务系统（登录 + 权限 + 财务录入）</h2>

  <div class="box">
    <h3>1) 登录 / 当前用户</h3>
    用户名：<input id="username" value="finance_a">
    密码：<input id="password" value="finance123" type="password">
    <button onclick="login()">登录</button>
    <button onclick="loadMe()">读取当前用户</button>
    <div>Token: <code id="tokenText">(未登录)</code></div>
  </div>

  <div class="box">
    <h3>2) 报表与台账</h3>
    公司ID：<input id="companyId" value="1">
    起始日期：<input id="dateFrom" value="2026-01-01">
    结束日期：<input id="dateTo" value="2026-01-31">
    <div>
      <button onclick="loadCostBenefit()">图1：成本效益分析</button>
      <button onclick="loadCostBenefitLedger()">台账：成本效益明细</button>
      <button onclick="loadApSummary()">图2：应付汇总</button>
      <button onclick="loadApAccrual()">应付计提明细</button>
      <button onclick="loadApPayment()">应付付款明细</button>
    </div>
  </div>

  <div class="box">
    <h3>3) 管理员接口</h3>
    新用户ID：<input id="newUserId" value="10">
    新用户名：<input id="newUsername" value="finance_new">
    新密码：<input id="newPassword" value="finance123">
    <div>
      <button onclick="loadUsers()">读取用户清单（管理员）</button>
      <button onclick="createUser()">创建财务用户（管理员）</button>
      <button onclick="deleteUser()">删除用户（管理员）</button>
    </div>
    删除用户ID：<input id="deleteUserId" value="10">
    <hr>
    用户ID：<input id="permUserId" value="2">
    公司ID：<input id="permCompanyId" value="1">
    <label><input id="grantRead" type="checkbox">添加读取权限</label>
    <label><input id="grantWrite" type="checkbox" checked>添加修改权限</label>
    <button onclick="addPermission()">添加公司权限</button>
    <br>
    <label><input id="removeRead" type="checkbox" checked>删除读取权限</label>
    <label><input id="removeWrite" type="checkbox" checked>删除修改权限</label>
    <button onclick="removePermission()">删除公司权限</button>
    <button onclick="loadPermissions()">读取权限清单（管理员）</button>
  </div>

  <div class="box">
    <h3>4) 用户卡片视图</h3>
    <div id="userCards"></div>
  </div>

  <h3>接口返回（JSON）</h3>
  <pre id="out">点击按钮开始测试</pre>

<script>
let token = "";

async function fetchJson(url, options = {}) {
  const headers = Object.assign({}, options.headers || {});
  if (token) headers["Authorization"] = `Bearer ${token}`;
  const r = await fetch(url, Object.assign({}, options, { headers }));
  return await r.json();
}

function getParams() {
  return {
    companyId: document.getElementById('companyId').value.trim(),
    dateFrom: document.getElementById('dateFrom').value.trim(),
    dateTo: document.getElementById('dateTo').value.trim()
  };
}

function show(data) { document.getElementById('out').textContent = JSON.stringify(data, null, 2); }

async function login() {
  const data = await fetchJson('/api/auth/login', {
    method: 'POST', headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ username: username.value.trim(), password: password.value.trim() })
  });
  if (data.ok && data.data && data.data.token) {
    token = data.data.token;
    tokenText.textContent = token;
  }
  show(data);
}

async function loadMe() { show(await fetchJson('/api/me')); }
async function loadCostBenefit() { const p = getParams(); show(await fetchJson(`/api/reports/cost_benefit?company_id=${encodeURIComponent(p.companyId)}&date_from=${encodeURIComponent(p.dateFrom)}&date_to=${encodeURIComponent(p.dateTo)}`)); }
async function loadCostBenefitLedger() { const p = getParams(); show(await fetchJson(`/api/finance/cost_benefit?company_id=${encodeURIComponent(p.companyId)}&date_from=${encodeURIComponent(p.dateFrom)}&date_to=${encodeURIComponent(p.dateTo)}`)); }
async function loadApSummary() { const p = getParams(); show(await fetchJson(`/api/reports/ap_summary?company_id=${encodeURIComponent(p.companyId)}&date_from=${encodeURIComponent(p.dateFrom)}&date_to=${encodeURIComponent(p.dateTo)}`)); }
async function loadApAccrual() { const p = getParams(); show(await fetchJson(`/api/finance/ap_accrual?company_id=${encodeURIComponent(p.companyId)}&date_from=${encodeURIComponent(p.dateFrom)}&date_to=${encodeURIComponent(p.dateTo)}`)); }
async function loadApPayment() { const p = getParams(); show(await fetchJson(`/api/finance/ap_payment?company_id=${encodeURIComponent(p.companyId)}&date_from=${encodeURIComponent(p.dateFrom)}&date_to=${encodeURIComponent(p.dateTo)}`)); }
async function loadPermissions() { const data = await fetchJson('/api/admin/permissions'); show(data); if (data.ok) renderUsers(data.data.users || []); }

async function loadUsers() {
  const data = await fetchJson('/api/admin/users');
  show(data);
  if (data.ok) renderUsers(data.data.users || []);
}

async function createUser() {
  show(await fetchJson('/api/admin/users', {
    method: 'POST', headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ userId: Number(newUserId.value.trim()), username: newUsername.value.trim(), password: newPassword.value.trim(), isAdmin: false })
  }));
}

async function deleteUser() {
  const data = await fetchJson('/api/admin/users/delete', {
    method: 'POST', headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ targetUserId: Number(deleteUserId.value.trim()) })
  });
  show(data);
  if (data.ok) await loadUsers();
}

async function addPermission() {
  const data = await fetchJson('/api/admin/permissions/company/add', {
    method: 'POST', headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({
      targetUserId: Number(permUserId.value.trim()), companyId: Number(permCompanyId.value.trim()),
      grantRead: grantRead.checked, grantWrite: grantWrite.checked
    })
  });
  show(data);
  if (data.ok) await loadUsers();
}

async function removePermission() {
  const data = await fetchJson('/api/admin/permissions/company/remove', {
    method: 'POST', headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({
      targetUserId: Number(permUserId.value.trim()), companyId: Number(permCompanyId.value.trim()),
      removeRead: removeRead.checked, removeWrite: removeWrite.checked
    })
  });
  show(data);
  if (data.ok) await loadUsers();
}

async function onPermissionToggle(userId, companyId, type, checked) {
  const endpoint = checked ? '/api/admin/permissions/company/add' : '/api/admin/permissions/company/remove';
  const body = { targetUserId: userId, companyId: companyId, grantRead: false, grantWrite: false, removeRead: false, removeWrite: false };
  if (type === 'read') {
    body.grantRead = checked;
    body.removeRead = !checked;
  } else {
    body.grantWrite = checked;
    body.removeWrite = !checked;
  }
  const data = await fetchJson(endpoint, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(body) });
  show(data);
  if (data.ok) await loadUsers();
}

function renderUsers(users) {
  const root = document.getElementById('userCards');
  root.innerHTML = '';
  users.forEach((u, idx) => {
    const card = document.createElement('div');
    card.className = 'user-card';
    const detailId = `detail_${idx}_${u.userId}`;
    const companies = (u.companies || []).filter(c => c.canRead || c.canWrite);
    card.innerHTML = `
      <div class="user-head">
        <div><b>${u.username}</b> (ID: ${u.userId}) ${u.isAdmin ? '[管理员]' : ''}</div>
        <button onclick="document.getElementById('${detailId}').classList.toggle('hidden')">展开/收起</button>
      </div>
      <div id="${detailId}" class="hidden" style="padding: 0 12px 12px 12px;">
        ${companies.length === 0 ? '<div>无公司权限</div>' : `
          <table class="user-table">
            <thead><tr><th>公司ID</th><th>读取权限</th><th>修改权限</th></tr></thead>
            <tbody>
              ${companies.map(c => `
                <tr>
                  <td>${c.companyId}</td>
                  <td><input type="checkbox" ${c.canRead ? 'checked' : ''} onchange="onPermissionToggle(${u.userId}, ${c.companyId}, 'read', this.checked)"></td>
                  <td><input type="checkbox" ${c.canWrite ? 'checked' : ''} onchange="onPermissionToggle(${u.userId}, ${c.companyId}, 'write', this.checked)"></td>
                </tr>`).join('')}
            </tbody>
          </table>`}
      </div>`;
    root.appendChild(card);
  });
}
</script>
</body>
</html>
